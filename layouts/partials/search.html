{{- /* Search Box Component */ -}}
<div class="search-container">
  <form class="search-box-wrapper" action="/search/" method="get" role="search">
    <input 
      type="text" 
      id="search-input" 
      class="search-input" 
      name="q"
      placeholder="T√¨m ki·∫øm ch·ªß ƒë·ªÅ, b√†i vi·∫øt..." 
      autocomplete="off"
      aria-label="T√¨m ki·∫øm"
    />
    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="11" cy="11" r="8"></circle>
      <path d="m21 21-4.35-4.35"></path>
    </svg>
    <button class="search-clear" id="search-clear" aria-label="X√≥a t√¨m ki·∫øm" style="display: none;">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </form>
  <div id="search-results" class="search-results" style="display: none;"></div>
</div>

<style>
  .search-container {
    position: relative;
    margin-left: 1rem;
    flex: 0 0 auto;
    display: flex;
    align-items: center;
  }

  .search-box-wrapper {
    position: relative;
    display: flex;
    align-items: center;
  }

  .search-input {
    width: 100%;
    height: 34px;
    padding: 0 2.5rem 0 2rem;
    border: 1px solid var(--border);
    border-radius: 18px;
    background: var(--entry);
    color: var(--primary);
    font-size: 0.9rem;
    transition: all 0.2s ease;
    outline: none;
    line-height: 1;
    box-shadow: 0 2px 6px rgba(0,0,0,0.12);
  }

  .search-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(76, 154, 255, 0.12);
  }

  .search-input::placeholder {
    color: var(--secondary);
    opacity: 0.6;
  }

  .search-icon {
    position: absolute;
    left: 0.6rem;
    color: var(--secondary);
    pointer-events: none;
    width: 14px;
    height: 14px;
  }

  .search-clear {
    position: absolute;
    right: 0.45rem;
    background: none;
    border: none;
    color: var(--secondary);
    cursor: pointer;
    padding: 0.15rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s ease;
    width: 18px;
    height: 18px;
  }

  .search-clear:hover {
    color: var(--primary);
  }

  .search-results {
    position: absolute;
    top: calc(100% + 0.5rem);
    left: 0;
    right: 0;
    max-height: 500px;
    overflow-y: auto;
    background: var(--theme);
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    margin-top: 0.25rem;
  }

  .search-results-section {
    padding: 0.75rem 0;
  }

  .search-results-section-title {
    padding: 0.5rem 1rem;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 0.5rem;
  }

  .search-result-item {
    display: block;
    padding: 0.75rem 1rem;
    text-decoration: none;
    color: var(--primary);
    transition: background 0.2s ease;
    border-bottom: 1px solid var(--border);
  }

  .search-result-item:last-child {
    border-bottom: none;
  }

  .search-result-item:hover {
    background: var(--hljs-bg);
  }

  .search-result-item-title {
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 0.25rem;
    color: var(--primary);
  }

  .search-result-item-meta {
    font-size: 0.85rem;
    color: var(--secondary);
  }

  .search-result-item-description {
    font-size: 0.85rem;
    color: var(--secondary);
    margin-top: 0.25rem;
    line-height: 1.4;
  }

  .search-no-results {
    padding: 1.5rem;
    text-align: center;
    color: var(--secondary);
    font-size: 0.9rem;
  }

  .search-highlight {
    background: var(--accent);
    color: var(--theme);
    padding: 0.1rem 0.2rem;
    border-radius: 3px;
    font-weight: 600;
  }

  @media (max-width: 1024px) {
    .search-container {
      width: 100%;
    }

    .search-input {
      width: 100%;
    }

    .search-input:focus {
      width: 100%;
    }
  }

  @media (max-width: 768px) {
    .search-container {
      margin-left: 0;
      order: -1;
      width: 100%;
      margin-bottom: 0.5rem;
    }

    .search-input {
      width: 100%;
    }

    .search-input:focus {
      width: 100%;
    }

    .search-results {
      left: 0;
      right: 0;
      max-height: 400px;
    }
  }
</style>

<script>
  (function() {
    // Search data s·∫Ω ƒë∆∞·ª£c load t·ª´ JSON
    let searchData = [];
    let fuse = null;

    // Load search data
    async function loadSearchData() {
      try {
        // Try multiple possible paths
        const possiblePaths = [
          '/search-index.json',
          './search-index.json',
          window.location.origin + '/search-index.json'
        ];
        
        let loaded = false;
        for (const path of possiblePaths) {
          try {
            const response = await fetch(path);
            if (response.ok) {
              const data = await response.json();
              if (Array.isArray(data) && data.length > 0) {
                searchData = data;
                console.log('Search data loaded:', searchData.length, 'items');
                loaded = true;
                break;
              }
            }
          } catch (e) {
            console.log('Failed to load from', path, e);
          }
        }
        
        if (!loaded) {
          console.error('Failed to load search data from all paths');
          return;
        }
        
        // Initialize Fuse.js if available (optional)
        if (typeof Fuse !== 'undefined') {
          fuse = new Fuse(searchData, {
            keys: [
              { name: 'title', weight: 0.7 },
              { name: 'content', weight: 0.3 },
              { name: 'categories', weight: 0.5 },
              { name: 'tags', weight: 0.4 }
            ],
            threshold: 0.4,
            includeScore: true,
            minMatchCharLength: 1
          });
          console.log('Fuse.js initialized');
        } else {
          // Load Fuse.js from CDN if not available
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js';
          script.onload = function() {
            fuse = new Fuse(searchData, {
              keys: [
                { name: 'title', weight: 0.7 },
                { name: 'content', weight: 0.3 },
                { name: 'categories', weight: 0.5 },
                { name: 'tags', weight: 0.4 }
              ],
              threshold: 0.4,
              includeScore: true,
              minMatchCharLength: 1
            });
            console.log('Fuse.js loaded and initialized');
          };
          script.onerror = function() {
            console.log('Fuse.js failed to load, using simple search');
          };
          document.head.appendChild(script);
        }
      } catch (error) {
        console.error('Error loading search data:', error);
      }
    }

    // Simple search function (fallback if Fuse.js not available)
    function simpleSearch(query) {
      if (!query || query.length < 1) {
        return { categories: [], posts: [], query };
      }
      
      const lowerQuery = query.toLowerCase().trim();
      const results = {
        categories: [],
        posts: [],
        query: query
      };

      if (searchData.length === 0) {
        console.warn('Search data is empty');
        return results;
      }

      searchData.forEach(item => {
        if (!item) return;
        
        const title = (item.title || '').toLowerCase();
        const content = (item.content || '').toLowerCase();
        const categories = Array.isArray(item.categories) ? item.categories : [];
        const tags = Array.isArray(item.tags) ? item.tags : [];
        
        const titleMatch = title.includes(lowerQuery);
        const contentMatch = content.includes(lowerQuery);
        const categoryMatch = categories.some(cat => {
          const catStr = typeof cat === 'string' ? cat : String(cat);
          return catStr.toLowerCase().includes(lowerQuery);
        });
        const tagMatch = tags.some(tag => {
          const tagStr = typeof tag === 'string' ? tag : String(tag);
          return tagStr.toLowerCase().includes(lowerQuery);
        });

        if (titleMatch || contentMatch || categoryMatch || tagMatch) {
          const score = (titleMatch ? 10 : 0) + (categoryMatch ? 5 : 0) + (tagMatch ? 3 : 0) + (contentMatch ? 1 : 0);
          
          if (item.type === 'category') {
            results.categories.push({ ...item, score });
          } else {
            results.posts.push({ ...item, score });
          }
        }
      });

      // Sort by score
      results.categories.sort((a, b) => b.score - a.score);
      results.posts.sort((a, b) => b.score - a.score);

      return results;
    }

    // Highlight search term
    function highlightText(text, query) {
      if (!query) return text;
      const regex = new RegExp(`(${query})`, 'gi');
      return text.replace(regex, '<mark class="search-highlight">$1</mark>');
    }

    // Render search results
    function renderResults(results) {
      const resultsContainer = document.getElementById('search-results');
      if (!resultsContainer) return;

      if (results.categories.length === 0 && results.posts.length === 0) {
        resultsContainer.innerHTML = '<div class="search-no-results">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o</div>';
        resultsContainer.style.display = 'block';
        return;
      }

      let html = '';

      // Categories section
      if (results.categories.length > 0) {
        html += '<div class="search-results-section">';
        html += '<div class="search-results-section-title">üìÅ Ch·ªß ƒë·ªÅ</div>';
        results.categories.slice(0, 5).forEach(item => {
          html += `
            <a href="${item.url}" class="search-result-item">
              <div class="search-result-item-title">${highlightText(item.title, results.query)}</div>
              <div class="search-result-item-meta">${item.count || 0} b√†i vi·∫øt</div>
            </a>
          `;
        });
        html += '</div>';
      }

      // Posts section
      if (results.posts.length > 0) {
        html += '<div class="search-results-section">';
        html += '<div class="search-results-section-title">üìù B√†i vi·∫øt</div>';
        results.posts.slice(0, 8).forEach(item => {
          const description = item.description || item.content?.substring(0, 100) || '';
          html += `
            <a href="${item.url}" class="search-result-item">
              <div class="search-result-item-title">${highlightText(item.title, results.query)}</div>
              ${item.categories ? `<div class="search-result-item-meta">${item.categories.join(', ')}</div>` : ''}
              ${description ? `<div class="search-result-item-description">${highlightText(description, results.query)}...</div>` : ''}
            </a>
          `;
        });
        html += '</div>';
      }

      resultsContainer.innerHTML = html;
      resultsContainer.style.display = 'block';
    }

    // Perform search (for dropdown suggestion)
    function performSearch(query) {
      if (!query || query.trim().length < 1) {
        const resultsContainer = document.getElementById('search-results');
        if (resultsContainer) {
          resultsContainer.style.display = 'none';
        }
        return;
      }

      const trimmedQuery = query.trim();
      let results = { categories: [], posts: [], query: trimmedQuery };

      if (searchData.length === 0) {
        return;
      }

      if (fuse) {
        try {
          const fuseResults = fuse.search(trimmedQuery);
          fuseResults.forEach(result => {
            const item = result.item;
            if (item && item.type === 'category') {
              results.categories.push(item);
            } else if (item) {
              results.posts.push(item);
            }
          });
        } catch (e) {
          console.error('Fuse.js search error:', e);
          results = simpleSearch(trimmedQuery);
        }
      } else {
        results = simpleSearch(trimmedQuery);
      }

      renderResults(results);
    }

    // Initialize search
    function initSearch() {
      const searchInput = document.getElementById('search-input');
      const searchClear = document.getElementById('search-clear');
      const searchResults = document.getElementById('search-results');

      if (!searchInput) return;

      // Load search data
      loadSearchData();

      // Search on input
      let searchTimeout;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        
        if (query) {
          searchClear.style.display = 'block';
        } else {
          searchClear.style.display = 'none';
          searchResults.style.display = 'none';
          return;
        }

        searchTimeout = setTimeout(() => {
          performSearch(query);
        }, 300);
      });

      // Clear search
      if (searchClear) {
        searchClear.addEventListener('click', () => {
          searchInput.value = '';
          searchClear.style.display = 'none';
          searchResults.style.display = 'none';
          searchInput.focus();
        });
      }

      // Submit on Enter -> redirect to search page with q param
      const form = searchInput.closest('form');
      if (form) {
        form.addEventListener('submit', (e) => {
          const q = searchInput.value.trim();
          if (!q) {
            e.preventDefault();
            return;
          }
          // allow normal navigation to /search/?q=...
        });
      }

      // Close results when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-container')) {
          searchResults.style.display = 'none';
        }
      });

      // Keyboard shortcuts
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          searchResults.style.display = 'none';
          searchInput.blur();
        }
      });
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSearch);
    } else {
      initSearch();
    }
  })();
</script>

