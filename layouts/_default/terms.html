{{- define "main" }}

{{- if .Title }}
<header class="page-header">
    <h1>{{ .Title }}</h1>
    {{- if .Description }}
    <div class="post-description">
        {{ .Description }}
    </div>
    {{- end }}
</header>
{{- end }}

{{- $type := .Type }}
{{- $terms := .Data.Terms.Alphabetical }}

{{- /* Nhóm categories theo parent */ -}}
{{- $parentGroups := dict }}
{{- $standaloneParents := dict }}
{{- range $key, $value := $terms }}
  {{- $name := .Name }}
  {{- $parts := split $name "/" }}
  {{- $parent := index $parts 0 }}
  {{- $child := "" }}
  {{- if gt (len $parts) 1 }}
    {{- $child = index $parts 1 }}
  {{- end }}
  
  {{- if $child }}
    {{- /* Có child, thêm vào parent group */ -}}
    {{- $parentData := index $parentGroups $parent }}
    {{- if not $parentData }}
      {{- $parentData = slice }}
    {{- end }}
    {{- $parentData = $parentData | append (dict "name" $name "count" .Count "child" $child) }}
    {{- $parentGroups = merge $parentGroups (dict $parent $parentData) }}
  {{- else }}
    {{- /* Không có child, đây là parent category độc lập */ -}}
    {{- $standaloneParents = merge $standaloneParents (dict $parent .Count) }}
  {{- end }}
{{- end }}

{{- /* Hiển thị categories theo nhóm */ -}}
<div class="categories-container">
  {{- /* Hiển thị parent categories có children trước */ -}}
  {{- range $parent, $children := $parentGroups }}
    {{- $parentPage := site.GetPage (printf "/%s/%s" $type $parent) }}
    {{- $totalCount := 0 }}
    {{- range $children }}
      {{- $totalCount = add $totalCount .count }}
    {{- end }}
    
    <div class="category-group">
      <h2 class="category-parent">
        {{- if $parentPage }}
        <a href="{{ $parentPage.Permalink }}">{{ $parent }}</a>
        {{- else }}
        {{ $parent }}
        {{- end }}
        <span class="category-parent-count">({{ $totalCount }})</span>
      </h2>
      
      <ul class="category-children">
        {{- range $children }}
          {{- $childPage := site.GetPage (printf "/%s/%s" $type .name) }}
          {{- if $childPage }}
          <li class="category-child">
            <a href="{{ $childPage.Permalink }}">
              {{ .child }}
              <sup><strong>{{ .count }}</strong></sup>
            </a>
          </li>
          {{- end }}
        {{- end }}
      </ul>
    </div>
  {{- end }}
  
  {{- /* Hiển thị parent categories không có children */ -}}
  {{- range $parent, $count := $standaloneParents }}
    {{- if not (hasKey $parentGroups $parent) }}
      {{- $parentPage := site.GetPage (printf "/%s/%s" $type $parent) }}
      {{- if $parentPage }}
      <div class="category-group">
        <h2 class="category-parent">
          <a href="{{ $parentPage.Permalink }}">{{ $parent }}</a>
          <span class="category-parent-count">({{ $count }})</span>
        </h2>
      </div>
      {{- end }}
    {{- end }}
  {{- end }}
</div>

<style>
  .categories-container {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    margin-top: 2rem;
  }

  .category-group {
    background: var(--theme);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: box-shadow 0.2s ease;
  }

  .category-group:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .category-parent {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0 0 1rem 0;
    color: var(--primary);
    border-bottom: 2px solid var(--border);
    padding-bottom: 0.5rem;
  }

  .category-parent a {
    color: var(--primary);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .category-parent a:hover {
    color: var(--accent);
  }

  .category-parent-count {
    font-size: 1rem;
    font-weight: 400;
    color: var(--secondary);
    margin-left: 0.5rem;
  }

  .category-children {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .category-child {
    margin: 0;
  }

  .category-child a {
    display: inline-block;
    padding: 0.5rem 1rem;
    background: var(--hljs-bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--primary);
    text-decoration: none;
    transition: all 0.2s ease;
    font-size: 0.95rem;
  }

  .category-child a:hover {
    background: var(--accent);
    color: var(--theme);
    border-color: var(--accent);
    transform: translateY(-2px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  }

  .category-child a sup {
    margin-left: 0.25rem;
    font-size: 0.85em;
    opacity: 0.8;
  }

  @media (max-width: 768px) {
    .categories-container {
      gap: 1.5rem;
    }

    .category-group {
      padding: 1rem;
    }

    .category-parent {
      font-size: 1.25rem;
    }

    .category-children {
      gap: 0.5rem;
    }

    .category-child a {
      padding: 0.4rem 0.8rem;
      font-size: 0.9rem;
    }
  }
</style>

{{- end }}{{/* end main */ -}}
